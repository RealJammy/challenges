from io import StringIO

from emojasm.run import run

from flask import (
    Flask,
    render_template,
    request
)

FLAG = "ractf{5huffl1n'}"
PRACTICE_FLAG = "ractf{testingflag}"

app = Flask(__name__)

@app.route('/')
def mainpage():
    return render_template("mainpage.html")

@app.route("/spec")
def spec():
    return render_template("spec.html")

@app.route("/run", methods=["POST","GET"])
def runpage():
    if request.method == "GET":
        return render_template("run.html")
    else:
        src = request.form["src"]
        initial_data = (
            "636631726c757d7466617b3568276e66000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "040a0108100b0c0d06020905030f0e07000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        )

        s = StringIO()

        try:
            run(src.replace("\r\n","\n"), initial_data, 50000, False, s)
            output = s.getvalue()
            s.close()
        except Exception as e:
            output = str(e)
        if output==FLAG:
            return render_template("output.html", output=output)
        else:
            return render_template("output.html", output="Output did not match flag. To see full output, use practice mode at /practice. (Your output needs to be the flag and ONLY the flag! Trailing characters will invalidate it. Use :moyai: to halt your program when you're done reading the flag.")

@app.route("/practice", methods=["POST","GET"])
def practice():
    if request.method == "GET":
        return render_template("practice.html")
    else:
        src = request.form["src"]
        initial_data = (
            "67746e726366747374656c617d6167667b6900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "040e05070611020a0809120301100b0c0f0d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "72616374667b74657374696e67666c61677d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        )

        s = StringIO()

        try:
            if request.form.get("include_debug"):
                run(src.replace("\r\n","\n"), initial_data, 50000, False, s, show_dbg=True)
            else:
                run(src.replace("\r\n","\n"), initial_data, 50000, False, s)
            output = s.getvalue()
            s.close()
        except Exception as e:
            output = str(e)
        s.close()
        return render_template("practiceoutput.html", output=output, expected=PRACTICE_FLAG)


app.run(host="0.0.0.0", port=5000)
