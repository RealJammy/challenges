from io import StringIO

from emojasm.run import run

from flask import (
    Flask,
    render_template,
    request
)

FLAG = "ractf{x0rmoj1!}"
PRACTICE_FLAG = "ractf{testingflag}"

app = Flask(__name__)

@app.route('/')
def mainpage():
    return render_template("mainpage.html")

@app.route("/spec")
def spec():
    return render_template("spec.html")

@app.route("/run", methods=["POST","GET"])
def runpage():
    if request.method == "GET":
        return render_template("run.html")
    else:
        src = request.form["src"]
        initial_data = (
            "0a51112b0d48016f43325d3502005c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "7830725f6b33795f315f325f33212100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        )

        s = StringIO()

        try:
            run(src.replace("\r\n","\n"), initial_data, 50000, False, s)
            output = s.getvalue()
            s.close()
        except Exception as e:
            output = str(e)
        if "ractf{" in output:
            return render_template("output.html", output=output)
        else:
            return render_template("output.html", output="Output did not match flag. To see full output, use practice mode at /practice. (Your output needs to be the flag and ONLY the flag! Trailing characters will invalidate it. Use :moyai: to halt your program when you're done reading the flag.")

@app.route("/practice", methods=["POST","GET"])
def practice():
    if request.method == "GET":
        return render_template("practice.html")
    else:
        src = request.form["src"]
        initial_data = (
            "0a0e111f03020c0a011f0c171f301407041e05000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "786f726b6579786f726b6579786f726b657978000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        )

        s = StringIO()

        try:
            if request.form.get("include_debug"):
                run(src.replace("\r\n","\n"), initial_data, 50000, False, s, show_dbg=True)
            else:
                run(src.replace("\r\n","\n"), initial_data, 50000, False, s)
            output = s.getvalue()
            s.close()
        except Exception as e:
            output = str(e)
        s.close()
        return render_template("practiceoutput.html", output=output, expected=PRACTICE_FLAG)


app.run(host="0.0.0.0", port=5000)
